const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/actually-explain-CmcXb-ud.js","js/rapid-press-event-B_dua6Iq.js","js/base-minigame-BKAltXfh.js","js/index-c0fuZDJO.js","js/index-BrR1G-mg.css","js/ban-chatters-C07ukmcA.js","js/click-target-CElWWxe_.js","js/bathroom-break-DxAIQkWk.js","js/timer-BgpETdvb.js","js/ferret-click-BTo00ucu.js","js/flex-power-DKUyli9G.js","js/roach-raid-DulWM31Y.js","js/tweet-wisdom-A7w6U0_5.js","js/voice-slide-DFWIuT5u.js","js/code-challenge-Mmz59o6e.js","js/base-event-BLT1_Wdv.js","js/dodge-accountability-DXskuCnP.js","js/kill-petitions-BCctHwLp.js","js/paint-explain-STbkQBMC.js","js/roach-escape-BnODyoaQ.js"])))=>i.map(i=>d[i]);
import{C as o,_ as g,J as m,P as p,R as C,T as R,B as k,a as A,U as S,s as M}from"./index-c0fuZDJO.js";const T=(f,e,t)=>{const s=f[e];return s?typeof s=="function"?s():Promise.resolve(s):new Promise((i,n)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(n.bind(null,new Error("Unknown variable dynamic import: "+e+(e.split("/").length!==t?". Note that variables only represent file names one level deep.":""))))})};class x{constructor(e,t=null){this.scene=e,this.eventManager=t,this.simpleEvents=new Map,this.complexEvents=new Map,this.initialized=!1}async initialize(){if(!this.initialized)try{await this.loadSimpleEvents(),await this.loadComplexEvents(),this.initialized=!0}catch(e){throw console.error("❌ Event Loader initialization failed:",e),e}}async loadSimpleEvents(){const e=o.EVENT_REGISTRY.simple;for(const t of e)try{const s=await fetch(`./js/events/simple/${t}/${t}.json`);if(!s.ok){console.warn(`⚠️ Config not found for simple event: ${t}`);continue}const i=await s.json(),n=await T(Object.assign({"./simple/actually-explain/actually-explain.js":()=>g(()=>import("./actually-explain-CmcXb-ud.js"),__vite__mapDeps([0,1,2,3,4])),"./simple/ban-chatters/ban-chatters.js":()=>g(()=>import("./ban-chatters-C07ukmcA.js"),__vite__mapDeps([5,2,3,4,6])),"./simple/bathroom-break/bathroom-break.js":()=>g(()=>import("./bathroom-break-DxAIQkWk.js"),__vite__mapDeps([7,2,3,4,6,8])),"./simple/ferret-click/ferret-click.js":()=>g(()=>import("./ferret-click-BTo00ucu.js"),__vite__mapDeps([9,2,3,4,6,8])),"./simple/flex-power/flex-power.js":()=>g(()=>import("./flex-power-DKUyli9G.js"),__vite__mapDeps([10,1,2,3,4])),"./simple/roach-raid/roach-raid.js":()=>g(()=>import("./roach-raid-DulWM31Y.js"),__vite__mapDeps([11,2,3,4,8])),"./simple/tweet-wisdom/tweet-wisdom.js":()=>g(()=>import("./tweet-wisdom-A7w6U0_5.js"),__vite__mapDeps([12,1,2,3,4])),"./simple/voice-slide/voice-slide.js":()=>g(()=>import("./voice-slide-DFWIuT5u.js"),__vite__mapDeps([13,2,3,4,8]))}),`./simple/${t}/${t}.js`,4),a=this.getEventClass(n,t);if(!a){console.warn(`⚠️ Event class not found in module: ${t}`);continue}this.simpleEvents.set(t,{id:t,config:i,EventClass:a,type:"simple"})}catch(s){console.error(`❌ Failed to load simple event ${t}:`,s)}}async loadComplexEvents(){const e=o.EVENT_REGISTRY.complex;for(const t of e)try{const s=await fetch(`./js/events/complex/${t}/${t}.json`);if(!s.ok){console.warn(`⚠️ Config not found for complex event: ${t}`);continue}const i=await s.json(),n=await T(Object.assign({"./complex/code-challenge/code-challenge.js":()=>g(()=>import("./code-challenge-Mmz59o6e.js"),__vite__mapDeps([14,3,4,15])),"./complex/dodge-accountability/dodge-accountability.js":()=>g(()=>import("./dodge-accountability-DXskuCnP.js"),__vite__mapDeps([16,3,4,15])),"./complex/kill-petitions/kill-petitions.js":()=>g(()=>import("./kill-petitions-BCctHwLp.js"),__vite__mapDeps([17,3,4,15])),"./complex/paint-explain/paint-explain.js":()=>g(()=>import("./paint-explain-STbkQBMC.js"),__vite__mapDeps([18,3,4,15])),"./complex/roach-escape/roach-escape.js":()=>g(()=>import("./roach-escape-BnODyoaQ.js"),__vite__mapDeps([19,15,3,4]))}),`./complex/${t}/${t}.js`,4),a=this.getEventClass(n,t);if(!a){console.warn(`⚠️ Event class not found in module: ${t}`);continue}this.complexEvents.set(t,{id:t,config:i,EventClass:a,type:"complex"})}catch(s){console.error(`❌ Failed to load complex event ${t}:`,s)}}getEventClass(e,t){const s=[this.toPascalCase(t)+"Minigame",this.toPascalCase(t)+"Event",this.toPascalCase(t)];for(const n of s)if(e[n])return e[n];const i=Object.keys(e);return console.warn(`Available exports in ${t}:`,i),null}toPascalCase(e){return e.split("-").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join("")}async getRandomEvent(){this.initialized||await this.initialize();const e=[...Array.from(this.simpleEvents.values()),...Array.from(this.complexEvents.values())];return e.length===0?(console.warn("No events available"),null):Phaser.Utils.Array.GetRandom(e)}async getRandomEventByType(e){this.initialized||await this.initialize();let t;if(e==="simple")t=Array.from(this.simpleEvents.values());else if(e==="complex")t=Array.from(this.complexEvents.values());else return console.warn(`Unknown event type: ${e}`),null;return t.length===0?(console.warn(`No ${e} events available`),null):Phaser.Utils.Array.GetRandom(t)}async createEventInstance(e){if(!e)return null;try{if(e.type==="simple"){const t=Date.now()+(e.config.timeout||5e3),s=new e.EventClass(this.scene,e.config,t);return s.deadline=t,{event:s,config:e.config,id:e.id}}else if(e.type==="complex"){const t=Date.now()+(e.config.timeout||1e4),s=new e.EventClass(this.eventManager,e.config,t);return s.deadline=t,{event:s,config:e.config,id:e.id}}else return console.warn(`Unknown event type: ${e.type}`),null}catch(t){return console.error(`Failed to create event instance for ${e.id}:`,t),null}}getEventStats(){return{simple:this.simpleEvents.size,complex:this.complexEvents.size,total:this.simpleEvents.size+this.complexEvents.size}}}class O{constructor(e){this.advancedEventSystem=e,this.config=o.ADVANCED_EVENT_SYSTEM.DEPENDENCIES,this.unlockedEvents=new Set,this.completedEvents=new Set,this.eventUnlockHistory=[],this.config.ENABLED&&(this.initializeBasicEvents(),this.loadDependencyData(),console.log("🔗 Event Dependency System initialized"))}initializeBasicEvents(){const e=["ferret-click","voice-slide","bathroom-break","ban-chatters"];e.forEach(t=>{this.unlockedEvents.add(t)}),console.log(`🔓 Initialized with ${e.length} basic events unlocked`)}isEventAvailable(e){if(!this.config.ENABLED||this.unlockedEvents.has(e))return!0;const t=this.config.RULES[e];return t?this.evaluateDependencyRule(t):!1}evaluateDependencyRule(e){switch(e.type){case this.config.TYPES.PREREQUISITE:return this.checkPrerequisites(e.requirements);case this.config.TYPES.SEQUENCE:return this.checkSequence(e.requirements);case this.config.TYPES.SKILL_GATE:return this.checkSkillGate(e.requirements);case this.config.TYPES.UNLOCK:return this.checkUnlockConditions(e.requirements);default:return console.warn(`Unknown dependency type: ${e.type}`),!1}}checkPrerequisites(e){if(e.events){for(const t of e.events)if(!this.completedEvents.has(t))return!1}return!(e.minCompletions&&this.getEventCompletionCount(e.eventId||e.category)<e.minCompletions)}checkSequence(e){if(!e.sequence||!Array.isArray(e.sequence))return!1;for(const t of e.sequence)if(!this.completedEvents.has(t))return!1;return!0}checkSkillGate(e){if(!e.category)return!1;const t=this.advancedEventSystem.categoryMetrics.get(e.category);if(!t||e.minSuccessRate&&t.successRate<e.minSuccessRate||e.minEvents&&t.totalEvents<e.minEvents||e.minAverageScore&&t.averageScore<e.minAverageScore)return!1;const s=this.advancedEventSystem.skillRating.get(e.category)||1;return!(e.minSkillRating&&s<e.minSkillRating)}checkUnlockConditions(e){if(e.totalEvents&&this.completedEvents.size<e.totalEvents||e.overallSuccessRate&&this.advancedEventSystem.getPerformanceAnalytics().successRate<e.overallSuccessRate)return!1;if(e.achievements){for(const t of e.achievements)if(!this.hasAchievement(t))return!1}return!0}filterAvailableEvents(e){return this.config.ENABLED?e.filter(t=>this.isEventAvailable(t.id)):e}recordEventCompletion(e,t){if(!this.config.ENABLED)return[];if(t){this.completedEvents.add(e);const s=this.checkForNewUnlocks();return s.length>0&&(console.log(`🔓 New events unlocked: ${s.join(", ")}`),s.forEach(i=>{this.eventUnlockHistory.push({eventId:i,unlockedBy:e,timestamp:Date.now()})})),s}return[]}checkForNewUnlocks(){const e=[];return Object.entries(this.config.RULES).forEach(([t,s])=>{!this.unlockedEvents.has(t)&&this.evaluateDependencyRule(s)&&(this.unlockedEvents.add(t),e.push(t))}),e}getEventCompletionCount(e){return e?this.completedEvents.has(e)?this.advancedEventSystem.sessionHistory.filter(t=>t.eventId===e&&t.success).length:this.advancedEventSystem.sessionHistory.filter(t=>t.category===e&&t.success).length:0}hasAchievement(e){const t=this.advancedEventSystem.getPerformanceAnalytics();switch(e){case"perfect_streak_5":return this.hasRecentSuccessStreak(5);case"perfect_streak_10":return this.hasRecentSuccessStreak(10);case"category_master":return Object.values(t.categoryBreakdown).some(s=>s.events>=10&&s.successRate>=90);case"speed_demon":return t.averageScore>=90;case"completionist":return t.totalEvents>=50;default:return!1}}hasRecentSuccessStreak(e){const t=this.advancedEventSystem.getRecentPerformance(e);return t.length>=e&&t.every(s=>s.success)}getEventDependencyInfo(e){if(!this.config.ENABLED)return{available:!0,locked:!1,requirements:null};const t=this.isEventAvailable(e),s=this.config.RULES[e];return{available:t,locked:!t,requirements:s?s.requirements:null,type:s?s.type:null,description:this.getRequirementDescription(s)}}getRequirementDescription(e){if(!e)return"Always available";switch(e.type){case this.config.TYPES.PREREQUISITE:if(e.requirements.events)return`Complete: ${e.requirements.events.join(", ")}`;if(e.requirements.minCompletions)return`Complete ${e.requirements.minCompletions} events in ${e.requirements.category||"any category"}`;break;case this.config.TYPES.SKILL_GATE:const t=e.requirements,s=[];return t.minSuccessRate&&s.push(`${(t.minSuccessRate*100).toFixed(0)}% success rate`),t.minEvents&&s.push(`${t.minEvents} events`),t.minAverageScore&&s.push(`${t.minAverageScore} average score`),`Achieve in ${t.category}: ${s.join(", ")}`;case this.config.TYPES.UNLOCK:const i=e.requirements,n=[];return i.totalEvents&&n.push(`Complete ${i.totalEvents} total events`),i.overallSuccessRate&&n.push(`${(i.overallSuccessRate*100).toFixed(0)}% overall success rate`),n.join(", ");default:return"Unknown requirements"}return"Requirements not specified"}getUnlockedEvents(){return Array.from(this.unlockedEvents)}getSystemStatus(){return{enabled:this.config.ENABLED,unlockedEvents:this.unlockedEvents.size,completedEvents:this.completedEvents.size,totalRules:Object.keys(this.config.RULES).length,recentUnlocks:this.eventUnlockHistory.slice(-5)}}saveDependencyData(){if(this.config.ENABLED)try{const e={unlockedEvents:Array.from(this.unlockedEvents),completedEvents:Array.from(this.completedEvents),eventUnlockHistory:this.eventUnlockHistory,lastSaved:Date.now()};localStorage.setItem("streamDrama_eventDependencies",JSON.stringify(e))}catch(e){console.warn("Failed to save dependency data:",e)}}loadDependencyData(){if(this.config.ENABLED)try{const e=localStorage.getItem("streamDrama_eventDependencies");if(!e)return;const t=JSON.parse(e);t.unlockedEvents&&Array.isArray(t.unlockedEvents)&&t.unlockedEvents.forEach(s=>this.unlockedEvents.add(s)),t.completedEvents&&Array.isArray(t.completedEvents)&&t.completedEvents.forEach(s=>this.completedEvents.add(s)),t.eventUnlockHistory&&Array.isArray(t.eventUnlockHistory)&&(this.eventUnlockHistory=t.eventUnlockHistory),console.log(`🔗 Loaded dependency data: ${this.unlockedEvents.size} unlocked, ${this.completedEvents.size} completed`)}catch(e){console.warn("Failed to load dependency data:",e)}}resetDependencyData(){this.unlockedEvents.clear(),this.completedEvents.clear(),this.eventUnlockHistory=[],this.config.ENABLED&&this.initializeBasicEvents();try{localStorage.removeItem("streamDrama_eventDependencies")}catch(e){console.warn("Failed to clear dependency data:",e)}console.log("🔄 Dependency data reset")}enable(){this.config.ENABLED||(this.config.ENABLED=!0,this.initializeBasicEvents(),console.log("🔗 Event Dependency System enabled"))}disable(){this.config.ENABLED&&(this.config.ENABLED=!1,console.log("🔗 Event Dependency System disabled"))}}class D{constructor(e){this.eventManager=e,this.config=o.ADVANCED_EVENT_SYSTEM,this.sessionHistory=[],this.performanceMetrics=new Map,this.categoryMetrics=new Map,this.currentDifficultyModifier=0,this.lastAdjustmentEvent=0,this.skillRating=new Map,this.categoryWeights=new Map,this.initializeCategoryWeights(),this.eventPlayHistory=new Map,this.eventRotationCycle=[],this.rotationIndex=0,this.dependencySystem=new O(this),this.loadPerformanceData()}initializeCategoryWeights(){Object.entries(this.config.CATEGORIES).forEach(([e,t])=>{this.categoryWeights.set(e,t.baseWeight),this.skillRating.set(e,1)})}async selectEvent(e=null){const t=Array.from(this.eventManager.eventLoader.simpleEvents.values()),s=Array.from(this.eventManager.eventLoader.complexEvents.values());if(t.length===0&&s.length===0)return console.warn("No events available for selection"),null;let i=e;i||(i=this.selectEventType());let n=[];if(i==="simple"&&t.length>0?n=t:i==="complex"&&s.length>0?n=s:n=[...t,...s],n.length===0)return null;const a=this.dependencySystem.filterAvailableEvents(n);a.length===0?(console.warn("No events available after dependency filtering, using fallback"),n=n.slice(0,3)):n=a;const r=this.applyEventRotation(n),c=this.selectEventByCategory(r);return c&&this.config.DYNAMIC_DIFFICULTY.ENABLED&&this.applyDifficultyScaling(c),c}selectEventType(){const e=this.getRecentPerformance(10);if(e.length<3)return Math.random()<.7?"simple":"complex";const t=e.reduce((i,n)=>i+n.score,0)/e.length;let s=.7;return t>85?s=.5:t<50&&(s=.85),Math.random()<s?"simple":"complex"}selectEventByCategory(e){if(e.length===1)return e[0];const t=new Map;e.forEach(a=>{const r=a.config.category||"unknown";t.has(r)||t.set(r,[]),t.get(r).push(a)});const s=[];t.forEach((a,r)=>{const c=this.config.CATEGORIES[r];if(!c)return;const h=c.baseWeight,u=this.skillRating.get(r)||1,d=h*u;s.push({category:r,events:a,weight:d})});const i=s.reduce((a,r)=>a+r.weight,0);let n=Math.random()*i;for(const a of s)if(n-=a.weight,n<=0)return a.events[Math.floor(Math.random()*a.events.length)];return e[Math.floor(Math.random()*e.length)]}applyEventRotation(e){if(!e||e.length===0)return e;const t=Date.now(),s=10*60*1e3;Math.max(3,e.length*.6),e.forEach(u=>{this.eventPlayHistory.has(u.id)||this.eventPlayHistory.set(u.id,0)});const i=[],n=[],a=[];e.forEach(u=>{const d=this.eventPlayHistory.get(u.id),l=t-d;d===0?i.push(u):l>s?n.push(u):a.push(u)}),n.sort((u,d)=>{const l=this.eventPlayHistory.get(u.id),v=this.eventPlayHistory.get(d.id);return l-v});let r=[...i,...n];r.length<Math.max(2,e.length*.4)&&(r=[...r,...a]);const c=Math.min(Math.max(3,Math.ceil(e.length*.7)),r.length),h=r.slice(0,c);return(i.length>0||n.length>0)&&console.log(`🔄 Event Rotation: ${i.length} never played, ${n.length} old, ${a.length} recent → ${h.length} candidates`),h.length>0?h:e}applyDifficultyScaling(e){const t=e.config.category,s=this.config.CATEGORIES[t];if(!s)return;let i=s.difficultyModifier+this.currentDifficultyModifier;const n=this.skillRating.get(t)||1;n>1.2?i+=.2:n<.8&&(i-=.2);const a=e.config.difficulty||1,r=Math.max(1,a*i),c=(r-a)*.15,h=Math.max(1e3,e.config.timeout*(1-c));e.config.scaledDifficulty=r,e.config.originalTimeout=e.config.timeout,e.config.timeout=Math.round(h)}recordEventPerformance(e,t,s){const i=Date.now(),n=t.category||"unknown",a=s.duration||0,r=t.originalTimeout||t.timeout,c=Math.max(0,(r-a)/r),h=s.accuracy||(s.success?100:0),u=s.efficiency||c*100,d=this.config.PERFORMANCE_ANALYTICS.METRICS,l=Math.round(c*d.completion_time.weight*100+h*d.accuracy.weight+u*d.efficiency.weight),v=this.calculateGrade(l),y={eventId:e,category:n,timestamp:i,success:s.success,duration:a,timeout:r,accuracy:h,efficiency:u,score:l,grade:v,difficulty:t.difficulty||1,scaledDifficulty:t.scaledDifficulty||t.difficulty||1};return this.sessionHistory.push(y),this.updateCategoryMetrics(n,y),this.updateSkillRating(n,y),this.eventPlayHistory.set(e,i),this.config.DYNAMIC_DIFFICULTY.ENABLED&&this.evaluateDifficultyAdjustment(),this.dependencySystem.recordEventCompletion(e,s.success),this.config.PERFORMANCE_ANALYTICS.SAVE_PERFORMANCE_DATA&&(this.savePerformanceData(),this.dependencySystem.saveDependencyData()),y}calculateGrade(e){const t=this.config.PERFORMANCE_ANALYTICS.GRADE_THRESHOLDS;return e>=t.S?"S":e>=t.A?"A":e>=t.B?"B":e>=t.C?"C":e>=t.D?"D":"F"}updateCategoryMetrics(e,t){this.categoryMetrics.has(e)||this.categoryMetrics.set(e,{totalEvents:0,successCount:0,totalScore:0,averageScore:0,successRate:0,recentPerformance:[]});const s=this.categoryMetrics.get(e);s.totalEvents++,t.success&&s.successCount++,s.totalScore+=t.score,s.averageScore=s.totalScore/s.totalEvents,s.successRate=s.successCount/s.totalEvents,s.recentPerformance.push(t),s.recentPerformance.length>10&&s.recentPerformance.shift()}updateSkillRating(e,t){const s=this.skillRating.get(e)||1,i=t.score/75,n=this.config.DYNAMIC_DIFFICULTY.SKILL_TRACKING.DECAY_FACTOR,a=s*n+i*(1-n);this.skillRating.set(e,Math.max(.5,Math.min(2,a)))}evaluateDifficultyAdjustment(){const e=this.sessionHistory.length,t=this.config.DYNAMIC_DIFFICULTY;if(e<t.EVALUATION_INTERVAL||e-this.lastAdjustmentEvent<t.ADJUSTMENT.COOLDOWN_EVENTS)return;const s=this.getRecentPerformance(t.SKILL_TRACKING.WINDOW_SIZE);if(s.length<t.SKILL_TRACKING.MIN_SAMPLE_SIZE)return;const i=s.filter(c=>c.success).length/s.length,n=s.reduce((c,h)=>c+h.score,0)/s.length;let a=0;const r=this.config.DIFFICULTY_SCALING.PERFORMANCE_SCALING;if(i>r.HIGH_SUCCESS_THRESHOLD&&n>80?a=t.ADJUSTMENT.STEP_SIZE:(i<r.LOW_SUCCESS_THRESHOLD||n<50)&&(a=-t.ADJUSTMENT.STEP_SIZE),a!==0){const c=t.ADJUSTMENT.MAX_STEPS,h=Math.max(-c,Math.min(c,a*c));this.currentDifficultyModifier+=h*t.ADJUSTMENT.STEP_SIZE,this.currentDifficultyModifier=Math.max(-.5,Math.min(1,this.currentDifficultyModifier)),this.lastAdjustmentEvent=e}}getRecentPerformance(e=10){return this.sessionHistory.slice(-e)}getPerformanceAnalytics(){const e=this.getRecentPerformance(20);if(e.length===0)return{totalEvents:0,successRate:0,averageScore:0,averageGrade:"N/A",categoryBreakdown:{}};const t=this.sessionHistory.length,s=e.filter(r=>r.success).length/e.length,i=e.reduce((r,c)=>r+c.score,0)/e.length,n=this.calculateGrade(i),a={};return this.categoryMetrics.forEach((r,c)=>{r.totalEvents>0&&(a[c]={events:r.totalEvents,successRate:r.successRate,averageScore:Math.round(r.averageScore),skillRating:this.skillRating.get(c)||1})}),{totalEvents:t,successRate:Math.round(s*100),averageScore:Math.round(i),averageGrade:n,categoryBreakdown:a,difficultyModifier:this.currentDifficultyModifier}}savePerformanceData(){try{const e={sessionHistory:this.sessionHistory.slice(-this.config.PERFORMANCE_ANALYTICS.MAX_SESSION_HISTORY),categoryMetrics:Object.fromEntries(this.categoryMetrics),skillRating:Object.fromEntries(this.skillRating),eventPlayHistory:Object.fromEntries(this.eventPlayHistory),difficultyModifier:this.currentDifficultyModifier,lastSaved:Date.now()};localStorage.setItem("streamDrama_advancedEventData",JSON.stringify(e))}catch(e){console.warn("Failed to save performance data:",e)}}loadPerformanceData(){try{const e=localStorage.getItem("streamDrama_advancedEventData");if(!e)return;const t=JSON.parse(e);t.sessionHistory&&Array.isArray(t.sessionHistory)&&(this.sessionHistory=t.sessionHistory),t.categoryMetrics&&Object.entries(t.categoryMetrics).forEach(([s,i])=>{this.categoryMetrics.set(s,i)}),t.skillRating&&Object.entries(t.skillRating).forEach(([s,i])=>{this.skillRating.set(s,i)}),typeof t.difficultyModifier=="number"&&(this.currentDifficultyModifier=t.difficultyModifier),t.eventPlayHistory&&Object.entries(t.eventPlayHistory).forEach(([s,i])=>{this.eventPlayHistory.set(s,i)})}catch(e){console.warn("Failed to load performance data:",e)}}resetPerformanceData(){this.sessionHistory=[],this.categoryMetrics.clear(),this.skillRating.clear(),this.eventPlayHistory.clear(),this.currentDifficultyModifier=0,this.lastAdjustmentEvent=0,this.initializeCategoryWeights(),this.dependencySystem.resetDependencyData();try{localStorage.removeItem("streamDrama_advancedEventData")}catch(e){console.warn("Failed to clear performance data:",e)}}getEventDependencyInfo(e){return this.dependencySystem.getEventDependencyInfo(e)}getDependencySystem(){return this.dependencySystem}}class b{constructor(e,t=!1){this.scene=e,this.responsiveLayout=e.responsiveLayout,this.currentEvent=null,this.eventHistory=[],this.eventLoader=new x(e,this),this.advancedEventSystem=new D(this),this.eventStartTime=null,this.nextEventTimer=null,this.hardCoreMode=t,this.scene.events.on("shutdown",()=>{console.log("🛑 EventManager: Scene shutting down, cleaning up"),this.cleanup()}),this.scene.events.on("destroy",()=>{console.log("🛑 EventManager: Scene destroyed, cleaning up"),this.cleanup()}),this.initializeEventSystem()}async initializeEventSystem(){try{await this.eventLoader.initialize();const e=this.eventLoader.getEventStats();console.log("✅ New Event System initialized"),console.log(`📊 Event stats: ${e.simple} simple, ${e.complex} complex events`)}catch(e){console.error("❌ Failed to initialize event system:",e)}}async spawnEvent(){if(!this.currentEvent&&!this.checkAndHandleCovid())try{await this.startAdvancedEvent()}catch(e){console.error("❌ Error spawning event:",e),this.scheduleNextEvent()}}checkAndHandleCovid(){if(this.scene.bottomBar){const e=this.scene.bottomBar.heartboundProgress,t=o.HEARTBOUND.COVID_SPAWN_THRESHOLD,s=this.scene.bottomBar.shouldSpawnCovid(),i=this.scene.bottomBar.covidActive;console.log(`🔍 COVID Check - Progress: ${e.toFixed(1)}%, Threshold: ${t}%, Should Spawn: ${s}, Active: ${i}`)}else console.log("❌ No bottomBar found on scene");return this.scene.bottomBar&&this.scene.bottomBar.shouldSpawnCovid()?(console.log("🦠 COVID threshold reached - triggering COVID attack instead of new event"),this.scene.bottomBar.triggerCovidAttack(),!0):this.scene.bottomBar&&this.scene.bottomBar.covidActive?(console.log("🦠 COVID is active - pausing event spawning"),!0):!1}async startAdvancedEvent(){const e=await this.advancedEventSystem.selectEvent();if(!e){console.warn("No events available from Advanced Event System, falling back to random"),Math.random()<.7?await this.startSimpleEvent():await this.startComplexEvent();return}const t=await this.eventLoader.createEventInstance(e);if(!t){console.warn("Failed to create advanced event instance"),await this.startSimpleEvent();return}this.currentEvent=t.event,this.eventStartTime=Date.now(),this.addToHistory(e.id,t.config,e.type),this.announceEvent(e.id,t.config),m.play(this.scene,"event_spawn",{volume:.5});try{await this.currentEvent.start();const s=t.config.timeout,i=Date.now()+s;this.scene.events.emit("event:started",t.config,i),console.log(`🎯 Advanced event started: ${e.id} (${e.type}) | Difficulty: ${t.config.scaledDifficulty||t.config.difficulty}`)}catch(s){throw console.error("❌ Error starting advanced event:",s),this.currentEvent=null,s}}async startSimpleEvent(){const e=await this.eventLoader.getRandomEventByType("simple");if(!e){console.warn("No simple events available, falling back to complex"),await this.startComplexEvent();return}const t=await this.eventLoader.createEventInstance(e);if(!t){console.warn("Failed to create simple event instance"),await this.startComplexEvent();return}this.currentEvent=t.event,this.eventStartTime=Date.now(),this.addToHistory(e.id,t.config,"simple"),this.announceEvent(e.id,t.config),m.play(this.scene,"event_spawn",{volume:.5});try{await this.currentEvent.start();const i=t.config.timeout||5e3,n=Date.now()+i;this.scene.events.emit("event:started",t.config,n)}catch(s){throw console.error("❌ Error starting simple event:",s),this.currentEvent=null,s}}async startComplexEvent(){const e=await this.eventLoader.getRandomEventByType("complex");if(!e){console.warn("No complex events available, falling back to simple"),await this.startSimpleEvent();return}const t=await this.eventLoader.createEventInstance(e);if(!t){console.warn("Failed to create complex event instance"),await this.startSimpleEvent();return}this.currentEvent=t.event,this.eventStartTime=Date.now(),this.addToHistory(e.id,t.config,"complex"),this.announceEvent(e.id,t.config),m.play(this.scene,"event_spawn",{volume:.5});try{await this.currentEvent.start();const i=t.config.timeout||1e4,n=Date.now()+i;this.scene.events.emit("event:started",t.config,n)}catch(s){throw console.error("❌ Error starting complex event:",s),this.currentEvent=null,s}}addToHistory(e,t,s){this.eventHistory.push({key:e,time:this.scene.time.now,config:t,type:s})}announceEvent(e,t){if(Math.random()<.3&&this.scene.chatManager){const s=[`${e} incoming!`,`Time for ${e}!`,`${e} challenge activated!`],i=p.Utils.Array.GetRandom(s);this.scene.chatManager.addSystemMessage(i,t.color)}}clearEvent(){this.currentEvent&&this.currentEvent.cleanup&&this.currentEvent.cleanup(),this.currentEvent=null,this.eventStartTime=null}cleanup(){console.log("🧹 EventManager: Cleaning up resources"),this.clearEvent(),this.nextEventTimer&&(this.nextEventTimer.destroy(),this.nextEventTimer=null),this.eventLoader&&this.eventLoader.cleanup&&this.eventLoader.cleanup(),this.advancedEventSystem&&this.advancedEventSystem.cleanup&&this.advancedEventSystem.cleanup()}scheduleNextEvent(){if(!this.scene.scene.isActive()){console.log("🛑 EventManager: Scene no longer active, stopping event scheduling");return}const t=this.scene.bottomBar&&this.scene.bottomBar.covidActive?1e3:p.Math.Between(2e3,5e3);this.nextEventTimer=this.scene.time.delayedCall(t,()=>{this.scene.scene.isActive()?this.spawnEvent():console.log("🛑 EventManager: Scene became inactive, skipping event spawn")})}eventSuccess(){this.recordEventPerformance(!0),this.scene.events.emit("event:success"),this.scene.events.emit("event:ended"),this.clearEvent(),this.scheduleNextEvent()}eventFailed(){if(this.recordEventPerformance(!1),this.scene.events.emit("event:fail"),this.scene.events.emit("event:ended"),this.clearEvent(),this.hardCoreMode){console.log("🔥 HARD CORE MODE: Event failed - triggering immediate game over!"),this.scene.handleGameOver("Hard Core: First event failed");return}this.scheduleNextEvent()}recordEventPerformance(e){if(!this.currentEvent||!this.eventStartTime)return;const s=Date.now()-this.eventStartTime,i=this.getEventConfigFromHistory();if(!i)return;const n={success:e,duration:s,accuracy:e?100:0,efficiency:e?Math.min(100,i.timeout/Math.max(s,1)*100):0};this.advancedEventSystem.recordEventPerformance(i.id,i,n)}getEventConfigFromHistory(){return this.eventHistory.length===0?null:this.eventHistory[this.eventHistory.length-1].config}checkInput(e,t){if(!this.currentEvent)return!1;try{return this.currentEvent.checkInput?this.currentEvent.checkInput(e,t):!1}catch(s){return console.error("Error checking input:",s),!1}}checkDeadline(e){return this.currentEvent?this.currentEvent.deadline&&e>this.currentEvent.deadline?(console.log("⏰ Event deadline exceeded"),this.currentEvent.timeout&&typeof this.currentEvent.timeout=="function"?(console.log("📞 Calling event timeout() method"),this.currentEvent.timeout()):(console.log("⚠️ Event has no timeout() method, using default fail"),this.scene.events.emit("event:fail")),!0):(this.currentEvent.update&&this.currentEvent.update(e,this.scene.game.loop.delta),!1):!1}getEventHistory(){return this.eventHistory}getCurrentEventInfo(){return this.currentEvent?{active:!0,type:this.currentEvent.constructor.name}:{active:!1}}getPerformanceAnalytics(){return this.advancedEventSystem.getPerformanceAnalytics()}resetPerformanceData(){this.advancedEventSystem.resetPerformanceData()}}class L{constructor(e,t=null){this.scene=e,this.responsiveLayout=t||new C(e.game),this.layout=this.responsiveLayout.getLayout(),this.createStreamerBox()}createStreamerBox(){const e=this.layout.streamerSpace;this.streamerContainer=this.scene.add.container(e.x,e.y),this.streamerContainer.setDepth(140);const t=this.scene.add.graphics();t.fillStyle(o.COLORS.UI_BG,.9),t.fillRoundedRect(0,0,e.width,e.height,e.borderRadius),t.lineStyle(e.strokeWidth,8947848,.8),t.strokeRoundedRect(0,0,e.width,e.height,e.borderRadius),this.streamerContainer.add(t),t.setDepth(141),this.faceContainer=this.scene.add.container(e.width/2,e.height/2),this.loadStreamerGif(),this.faceContainer.setDepth(142),this.streamerContainer.add(this.faceContainer),this.addGlowEffect()}addGlowEffect(){const e=this.layout.streamerSpace,t=this.scene.add.graphics();t.lineStyle(e.strokeWidth*2,16777215,.2),t.strokeRoundedRect(-2,-2,e.width+4,e.height+4,e.borderRadius+2),this.streamerContainer.addAt(t,0),this.scene.tweens.add({targets:t,alpha:[.2,.4,.2],duration:3e3,repeat:-1,ease:"Sine.easeInOut"})}showPlaceholder(){const e=this.scene.add.graphics();e.fillStyle(3355443,.5),e.fillCircle(0,0,Math.min(this.layout.streamerSpace.width,this.layout.streamerSpace.height)*.35),e.lineStyle(this.responsiveLayout.scale(2),6710886,1),e.strokeCircle(0,0,Math.min(this.layout.streamerSpace.width,this.layout.streamerSpace.height)*.35);const t=this.scene.add.text(0,0,"ps-roach.gif",{fontSize:this.layout.fonts.micro,fontFamily:'"Press Start 2P"',color:"#888888",align:"center"}).setOrigin(.5);this.faceContainer.add([e,t]),this.scene.tweens.add({targets:this.faceContainer,scaleX:[1,1.05,1],scaleY:[1,1.05,1],duration:2e3,repeat:-1,ease:"Sine.easeInOut"})}loadStreamerGif(){const e=this.scene.add.sprite(0,0,"ps-roach");e.play("ps-roach-idle");const t=this.layout.streamerSpace,i=Math.min(t.width,t.height)*1.25/Math.max(e.width,e.height);e.setScale(i);const n=this.scene.make.graphics();n.fillRoundedRect(t.x,t.y,t.width,t.height,t.borderRadius);const a=new p.Display.Masks.GeometryMask(this.scene,n);this.faceContainer.add(e),this.faceContainer.setMask(a)}replaceWithGif(e){this.faceContainer.removeAll(!0);const t=this.scene.add.sprite(0,0,e),s=this.layout.streamerSpace,i=Math.min(s.width,s.height)*.7,n=i/Math.max(t.width,t.height);t.setScale(n);const a=this.scene.make.graphics();a.fillCircle(s.x+s.width/2,s.y+s.height/2,i/2);const r=new p.Display.Masks.GeometryMask(this.scene,a);this.faceContainer.add(t),this.faceContainer.setMask(r),t.anims&&t.play(e)}addReaction(e){const t=this.layout.streamerSpace;let s,i;switch(e){case"success":s="😊",i=o.COLORS.SUCCESS;break;case"fail":s="😫",i=o.COLORS.FAIL;break;case"ban":s="🔨",i=o.COLORS.BAN;break;case"covid":s="😷",i=o.COLORS.COVID;break;default:s="🤔",i="#FFFFFF"}const n=this.scene.add.container(t.width*.85,t.height*.85),a=this.scene.add.graphics();a.fillStyle(0,.8),a.fillCircle(0,0,this.responsiveLayout.scale(15)),a.lineStyle(this.responsiveLayout.scale(2),parseInt(i.replace("#","0x"))||i,1),a.strokeCircle(0,0,this.responsiveLayout.scale(15));const r=this.scene.add.text(0,0,s,{fontSize:this.layout.fonts.ui}).setOrigin(.5);n.add([a,r]),this.streamerContainer.add(n),n.setScale(0),this.scene.tweens.add({targets:n,scale:[0,1.2,1],duration:400,ease:"Back.easeOut"}),this.scene.time.delayedCall(2e3,()=>{this.scene.tweens.add({targets:n,scale:0,alpha:0,duration:300,onComplete:()=>n.destroy()})})}showTyping(){if(this.typingIndicator)return;const e=this.layout.streamerSpace;this.typingIndicator=this.scene.add.container(e.width*.1,e.height*.9);const t=[];for(let s=0;s<3;s++){const i=this.scene.add.circle(s*this.responsiveLayout.scale(8),0,this.responsiveLayout.scale(2),16777215);t.push(i),this.typingIndicator.add(i)}this.streamerContainer.add(this.typingIndicator),t.forEach((s,i)=>{this.scene.tweens.add({targets:s,alpha:[1,.3,1],duration:600,repeat:-1,delay:i*200})})}hideTyping(){this.typingIndicator&&(this.typingIndicator.destroy(),this.typingIndicator=null)}destroy(){this.streamerContainer&&this.streamerContainer.destroy()}}class w{constructor(e={}){this.type=e.type||"letter",this.value=e.value||"SPACE",this.sprite=e.sprite||null,this.animation=e.animation||"press",this.scale=e.scale||1,this.color=e.color||null,this.style=e.style||"default",this.duration=e.duration||800,this.scene=null,this.container=null,this.elements=[],this.animationTween=null}create(e,t=0,s=0){switch(this.scene=e,this.container=e.add.container(t,s),this.elements=[],this.type){case"letter":this.createLetterKey();break;case"sprite":this.createSpriteKey();break;case"custom":this.createCustomKey();break;case"gamepad":this.createGamepadKey();break;default:this.createLetterKey()}return this.startAnimation(),this.container}createLetterKey(){const e=o.KEYBOARD_KEY,t=this.scale*.4,s=e.WIDTH*t,i=e.HEIGHT*t,n=e.DEPTH*t,a=this.getKeyColors(),r=this.scene.add.rectangle(n/2,n/2,s,i,a.shadow,.8);this.container.add(r),this.elements.push({element:r,type:"shadow"});const c=this.scene.add.rectangle(n/3,n/3,s,i,a.side);this.container.add(c),this.elements.push({element:c,type:"shadow"});const h=this.scene.add.rectangle(0,0,s,i,a.top).setStrokeStyle(Math.max(1,2*t),a.border);this.container.add(h),this.elements.push({element:h,type:"key"});const u=this.scene.add.rectangle(-s/6,-i/4,s/2,i/3,a.highlight,.3);this.container.add(u),this.elements.push({element:u,type:"key"});const d=Math.max(8,Math.round(26*t)),l=this.scene.add.text(0,0,this.getDisplayText(),{fontSize:d+"px",fontFamily:'"Press Start 2P"',color:a.text,stroke:a.textStroke,strokeThickness:Math.max(1,2*t)}).setOrigin(.5);this.container.add(l),this.elements.push({element:l,type:"key"}),this.width=s,this.height=i}createSpriteKey(){if(!this.sprite){console.warn("KeyObject: No sprite provided for sprite type key"),this.createLetterKey();return}const e=this.scene.add.sprite(0,0,this.sprite.texture,this.sprite.frame);e.setScale(this.scale*.4),this.container.add(e),this.elements.push({element:e,type:"key"}),this.width=e.displayWidth,this.height=e.displayHeight}createCustomKey(){console.warn("KeyObject: Custom key type not yet implemented, falling back to letter"),this.createLetterKey()}createGamepadKey(){const t={A:"🎮",B:"🔴",X:"❌",Y:"🟡",LB:"↖️",RB:"↗️",START:"▶️",SELECT:"⏹️"}[this.value]||"🎮",s=this.getKeyColors(),i=this.scene.add.circle(0,0,12*this.scale,s.top);i.setStrokeStyle(2*this.scale,s.border),this.container.add(i),this.elements.push({element:i,type:"key"});const n=this.scene.add.text(0,0,t,{fontSize:Math.round(14*this.scale)+"px"}).setOrigin(.5);this.container.add(n),this.elements.push({element:n,type:"key"}),this.width=24*this.scale,this.height=24*this.scale}getKeyColors(){const e=o.KEYBOARD_KEY;if(this.color){const t=parseInt(this.color.replace("#","0x"));return{top:t,side:t-2105376,shadow:t-4210752,border:t+2105376,highlight:16777215,text:e.TEXT_COLOR,textStroke:"#FFFFFF"}}switch(this.style){case"danger":return{top:16729156,side:13378082,shadow:10031377,border:16737894,highlight:16755370,text:"#FFFFFF",textStroke:"#000000"};case"success":return{top:4521796,side:2280482,shadow:1153297,border:6750054,highlight:11206570,text:"#000000",textStroke:"#FFFFFF"};case"warning":return{top:16755200,side:13404160,shadow:10053120,border:16763938,highlight:16772778,text:"#000000",textStroke:"#FFFFFF"};default:return{top:e.TOP_COLOR,side:e.SIDE_COLOR,shadow:e.BOTTOM_COLOR,border:e.BORDER_COLOR,highlight:16777215,text:e.TEXT_COLOR,textStroke:"#FFFFFF"}}}getDisplayText(){return{SPACE:"␣",ENTER:"↵",TAB:"⇥",SHIFT:"⇧",CTRL:"Ctrl",ALT:"Alt",ESC:"Esc",BACKSPACE:"⌫",DELETE:"Del",LEFT:"⬅️",RIGHT:"➡️",UP:"⬆️",DOWN:"⬇️"}[this.value.toUpperCase()]||this.value.toUpperCase()}startAnimation(){if(this.animation==="none")return;const e=this.elements.filter(s=>s.type==="key").map(s=>s.element),t=this.elements.filter(s=>s.type==="shadow").map(s=>s.element);switch(this.animation){case"press":this.animationTween=this.scene.tweens.add({targets:e,y:"+="+o.KEYBOARD_KEY.PRESS_OFFSET*this.scale*.4,duration:this.duration/2,repeat:-1,yoyo:!0,ease:"Power2.easeInOut",onUpdate:i=>{const a=.8-i.progress*.3;t.forEach(r=>{r.setAlpha(a)})}});break;case"pulse":this.animationTween=this.scene.tweens.add({targets:this.container,scaleX:[1,1.1,1],scaleY:[1,1.1,1],duration:this.duration,repeat:-1,ease:"Sine.easeInOut"});break;case"glow":const s=this.elements.filter(i=>i.type==="key"&&i.element.setTint);this.animationTween=this.scene.tweens.add({targets:{tint:0},tint:[0,.5,0],duration:this.duration,repeat:-1,onUpdate:i=>{const n=i.getValue(),a=16777215+Math.floor(n*4473924);s.forEach(r=>{r.element.setTint&&r.element.setTint(a)})}});break}}stopAnimation(){this.animationTween&&(this.animationTween.stop(),this.animationTween=null)}destroy(){this.stopAnimation(),this.container&&(this.container.destroy(),this.container=null),this.elements=[]}static createLetterKey(e,t={}){return new w({type:"letter",value:e,...t})}static createSpriteKey(e,t={}){return new w({type:"sprite",sprite:e,...t})}static createGamepadButton(e,t={}){return new w({type:"gamepad",value:e,...t})}}class _{constructor(e){this.scene=e}parseText(e,t={}){const s=[],i=/\{([^}]+)\}/g;let n=0,a;for(;(a=i.exec(e))!==null;){if(a.index>n){const h=e.substring(n,a.index);h.length>0&&s.push({type:"text",content:h})}const r=a[1],c=t[r]||this.getDefaultKeyConfig(r);s.push({type:"key",keyObject:new w(c),placeholder:r}),n=i.lastIndex}if(n<e.length){const r=e.substring(n);r.length>0&&s.push({type:"text",content:r})}return s.length===0&&s.push({type:"text",content:e}),s}renderSegments(e,t={},s=300){const i=this.scene.add.container(0,0);let n=0,a=0;const r=t.lineHeight||parseInt(t.fontSize||"16")+4;let c=[];e.forEach((d,l)=>{if(d.type==="text"){const v=this.scene.add.text(0,0,d.content,t),y=v.width,E=v.height;s&&n+y>s&&n>0&&(this.finalizeLine(c,s),c=[],n=0,a+=r),c.push({element:v,x:n,y:a,width:y,height:E,baseline:E*.8}),n+=y}else if(d.type==="key"){const v=d.keyObject.create(this.scene,0,0),y=d.keyObject.width||20,E=d.keyObject.height||20;s&&n+y>s&&n>0&&(this.finalizeLine(c,s),c=[],n=0,a+=r),c.push({element:v,keyObject:d.keyObject,x:n+y/2,y:a,width:y,height:E,baseline:E*.8}),n+=y+2}}),c.length>0&&this.finalizeLine(c,s);let h=0;const u=a+r;return c.forEach(d=>{i.add(d.element),h=Math.max(h,d.x+d.width)}),i.displayWidth=h,i.displayHeight=u,i}finalizeLine(e,t){if(e.length===0)return;let s=0,i=0;e.forEach(a=>{s=Math.max(s,a.x+a.width),i=Math.max(i,a.baseline)});const n=t?(t-s)/2:0;e.forEach(a=>{var c;const r=i-a.baseline;a.element.setPosition(a.x+n+(a.element===((c=a.keyObject)==null?void 0:c.container)?0:a.width/2),a.y+r),a.element.setOrigin&&!a.keyObject&&a.element.setOrigin(0,0)})}getDefaultKeyConfig(e){const t={SPACE:{type:"letter",value:"SPACE",animation:"press"},ENTER:{type:"letter",value:"ENTER",animation:"press"},ESC:{type:"letter",value:"ESC",animation:"pulse"},TAB:{type:"letter",value:"TAB",animation:"press"},SHIFT:{type:"letter",value:"SHIFT",animation:"press"},CTRL:{type:"letter",value:"CTRL",animation:"press"},ALT:{type:"letter",value:"ALT",animation:"press"}};return["A","B","X","Y","LB","RB","START","SELECT"].includes(e.toUpperCase())?{type:"gamepad",value:e.toUpperCase(),animation:"pulse"}:t[e.toUpperCase()]||{type:"letter",value:e,animation:"press"}}createTextWithKey(e,t,s={},i={}){const n=e.replace(new RegExp(`\\b${t}\\b`,"gi"),`{${t}}`),a={};a[t]=s;const r=this.parseText(n,a);return this.renderSegments(r,i)}destroyKeyObjects(e){!e||!e.list||e.list.forEach(t=>{t.keyObject&&t.keyObject.destroy&&t.keyObject.destroy()})}}class I{constructor(e,t=null){this.scene=e,this.container=null,this.timerGraphics=null,this.timerText=null,this.currentEvent=null,this.isVisible=!1,this.currentKeyContainer=null,this.responsiveLayout=t||new C(e.game),this.layout=this.responsiveLayout.getLayout();try{this.textRenderer=new _(e)}catch(s){console.warn("Timer Display: Could not initialize text renderer, using fallback:",s),this.textRenderer=null}this.createTimerContainer()}createTimerContainer(){const e=this.layout.timerSpace;if(!e||e.width<=0||e.height<=0){console.warn("Timer display: Invalid timer space dimensions");return}this.container=this.scene.add.container(e.x,e.y),this.container.setDepth(200),this.container.setVisible(!1),this.background=this.scene.add.graphics(),this.background.fillStyle(o.COLORS.UI_BG,.9),this.background.lineStyle(e.strokeWidth,o.COLORS.BORDER_GRAY,1),this.background.fillRoundedRect(0,0,e.width,e.height,e.borderRadius),this.background.strokeRoundedRect(0,0,e.width,e.height,e.borderRadius),this.container.add(this.background),this.timerGraphics=this.scene.add.graphics(),this.container.add(this.timerGraphics),this.timerText=this.scene.add.text(e.width/2,e.height*.6,"",{...o.TEXT_STYLES.UI,fontSize:this.layout.fonts.ui||o.TEXT_STYLES.UI.fontSize}).setOrigin(.5),this.container.add(this.timerText),this.titleContainer=this.scene.add.container(e.width/2,e.height*.3),this.container.add(this.titleContainer)}showTimer(e,t,s){if(!e||!this.container){console.warn("Timer display: Missing eventConfig or container");return}if(typeof t!="number"||typeof s!="number"){console.warn("Timer display: Invalid time parameters",{timeRemaining:t,totalTime:s});return}if(t>1e5&&console.warn("Timer display: Suspiciously large timeRemaining value:",{timeRemaining:t,totalTime:s,timeRemainingSeconds:Math.ceil(t/1e3),eventConfig:e.id||e.type}),s<=0){console.warn("Timer display: Invalid total time",s);return}this.currentEvent=e,this.isVisible=!0,this.container.setVisible(!0);let i="Event";e.message&&typeof e.message=="string"?i=e.message.split(`
`)[0]||"Event":e.type&&(i=e.type),this.updateTitleDisplay(e,i),this.updateTimer(t,s);const n=this.layout.timerSpace,a=n.y;this.container.setAlpha(0),this.container.setY(a+n.height),this.scene.tweens.add({targets:this.container,alpha:1,y:a,duration:400,ease:"Back.easeOut"})}updateTitleDisplay(e,t){this.titleContainer.removeAll(!0),this.createSimpleTitle(e,t)}createSimpleTitle(e,t){const s=this.getEventKeyInfo(e),i={fontSize:this.layout.fonts.menu||o.TEXT_STYLES.MENU.fontSize||"10px",fontFamily:o.TEXT_STYLES.MENU.fontFamily||"Arial",color:e.color||"#FFFFFF"};let n=t;s&&s.key&&s.type==="letter"&&(n=`Press ${s.key}`);const a=this.scene.add.text(0,0,n,i).setOrigin(.5);this.titleContainer.add(a)}createTextWithSimpleKey(e,t,s){const i=this.scene.add.container(0,0),n=new RegExp(`\\b${t.key}\\b`,"gi");let a="",r="";if(n.test(e)){const l=e.split(n);a=l[0]||"",r=l[1]||""}else a=e+" ",r="";const c=[];if(a.trim()){const l=this.scene.add.text(0,0,a,s);c.push({element:l,width:l.width})}const h=this.createKeyVisual(t.key,t.type||"letter");if(c.push({element:h.rect,width:h.width}),r.trim()){const l=this.scene.add.text(0,0,r,s);c.push({element:l,width:l.width})}let d=-c.reduce((l,v)=>l+v.width+2,-2)/2;c.forEach((l,v)=>{const y=d+l.width/2;l.element.setPosition(y,0),l.element.setOrigin&&l.element.setOrigin(.5),i.add(l.element),d+=l.width+2}),this.titleContainer.add(i)}createKeyVisual(e,t="letter"){const s=this.scene.add.container(0,0),i=this.scene.add.rectangle(0,0,o.UI.KEY_SIZE,o.UI.KEY_SIZE,o.COLORS.KEY_BG);i.setStrokeStyle(2,o.COLORS.BORDER_GRAY),s.add(i);let n;return t==="icon"?n=this.createIcon(e):n=this.scene.add.text(0,0,e,{...o.TEXT_STYLES.KEY_TEXT}).setOrigin(.5),s.add(n),s.keyRect=i,s.keyContent=n,this.scene.tweens.add({targets:s,y:s.y+1,duration:800,repeat:-1,yoyo:!0,ease:"Power2.easeInOut"}),this.currentKeyContainer=s,{rect:s,width:o.UI.KEY_SIZE,height:o.UI.KEY_SIZE}}createIcon(e){switch(e){case"MOUSE":return this.createMouseIcon();case"RAPID":return this.createRapidIcon();case"SLIDER":return this.createSliderIcon();case"ARROWS":return this.createArrowsIcon();case"KEY":return this.createKeyboardIcon();default:return this.scene.add.text(0,0,"?",{...o.TEXT_STYLES.KEY_TEXT}).setOrigin(.5)}}createMouseIcon(){const e=this.scene.add.graphics();return e.fillStyle(0),e.lineStyle(1,0),e.fillRoundedRect(-6,-4,12,8,3),e.fillStyle(13421772),e.fillRect(-5,-3,4,2),e.fillRect(1,-3,4,2),e.lineStyle(1,6710886),e.beginPath(),e.moveTo(0,-2),e.lineTo(0,1),e.strokePath(),e}createRapidIcon(){const e=this.scene.add.graphics();e.fillStyle(0);for(let t=0;t<3;t++){const s=(t-1)*4;e.beginPath(),e.moveTo(-2,-2+s),e.lineTo(0,2+s),e.lineTo(2,-2+s),e.lineTo(0,0+s),e.closePath(),e.fillPath()}return e}createSliderIcon(){const e=this.scene.add.graphics();return e.lineStyle(2,0),e.beginPath(),e.moveTo(-8,0),e.lineTo(8,0),e.strokePath(),e.fillStyle(0),e.fillRect(-2,-4,4,8),e}createArrowsIcon(){const e=this.scene.add.graphics();return e.fillStyle(0),e.beginPath(),e.moveTo(-3,-2),e.lineTo(0,-6),e.lineTo(3,-2),e.lineTo(0,-4),e.closePath(),e.fillPath(),e.beginPath(),e.moveTo(-3,2),e.lineTo(0,6),e.lineTo(3,2),e.lineTo(0,4),e.closePath(),e.fillPath(),e}createKeyboardIcon(){const e=this.scene.add.graphics();return e.fillStyle(0),e.lineStyle(1,0),e.fillRoundedRect(-6,-3,12,6,2),e.strokeRoundedRect(-6,-3,12,6,2),e.fillStyle(13421772),e.fillRoundedRect(-5,-2,10,4,1),e}shakeKey(){if(!(!this.currentKeyContainer||!this.currentKeyContainer.active)&&(this.scene.tweens.add({targets:this.currentKeyContainer,x:[0,-3,3,-2,2,0],duration:150,ease:"Power2.easeInOut",onComplete:()=>{this.currentKeyContainer.x=0}}),this.currentKeyContainer.keyRect)){const e=this.currentKeyContainer.keyRect.fillColor;this.currentKeyContainer.keyRect.setFillStyle(o.COLORS.KEY_FLASH),this.scene.time.delayedCall(100,()=>{this.currentKeyContainer&&this.currentKeyContainer.keyRect&&this.currentKeyContainer.keyRect.setFillStyle(e)})}}getEventKeyInfo(e){var n;if(e.key)return{key:e.key.toUpperCase(),type:"letter",animation:"press"};const t=e.id||((n=e.type)==null?void 0:n.toLowerCase()),s=o.EVENT_KEYS[t];if(s)return s;const i=e.mechanics||[];return i.includes("click-target")?{key:"MOUSE",type:"icon",animation:"press"}:i.includes("rapid-press")?{key:"RAPID",type:"icon",animation:"pulse"}:i.includes("slider")?{key:"SLIDER",type:"icon",animation:"press"}:i.includes("input-sequence")?{key:"ARROWS",type:"icon",animation:"press"}:i.includes("keypress")||e.type==="KEYPRESS"?{key:"KEY",type:"icon",animation:"press"}:null}getKeyStyle(e){if(e.color){const t=parseInt(e.color.replace("#","0x"));if(t>16729156)return"danger";if(t>4521796)return"warning";if(t===4521796)return"success"}return"default"}updateTimer(e,t){if(!this.isVisible||!this.currentEvent)return;const s=this.layout.timerSpace,i=Math.max(0,Math.min(1,e/t)),n=Math.max(0,Math.ceil(e/1e3));this.timerText&&this.timerText.setText&&this.timerText.setText(n>0?`${n}s`:"0s"),this.timerGraphics.clear(),this.getEventType(this.currentEvent);try{this.drawProgressBar(i,s)}catch(a){console.warn("Timer display error:",a)}}getEventType(e){return"progress"}drawProgressBar(e,t){const s=t.width*.1,i=t.height*.75,n=t.width*.8,a=t.height*.12,r=4;if(n<=0||a<=0)return;let c=o.COLORS.PRIMARY;try{this.currentEvent.color&&(c=parseInt(this.currentEvent.color.replace("#","0x")))}catch{c=parseInt(o.COLORS.PRIMARY.replace("#","0x"))}this.timerGraphics.fillStyle(o.COLORS.GAUGE_BG,.8),this.timerGraphics.fillRoundedRect(s,i,n,a,r),e>0&&e<=1&&(this.timerGraphics.fillStyle(c,.8),this.timerGraphics.fillRoundedRect(s,i,n*e,a,r)),this.timerGraphics.lineStyle(2,c,1),this.timerGraphics.strokeRoundedRect(s,i,n,a,r)}hideTimer(){if(!this.isVisible)return;this.isVisible=!1,this.currentEvent=null,this.titleContainer&&this.titleContainer.removeAll(!0);const e=this.layout.timerSpace;this.scene.tweens.add({targets:this.container,alpha:0,y:e.y+e.height,duration:300,ease:"Back.easeIn",onComplete:()=>{this.container.setVisible(!1),this.container.setY(e.y),this.timerGraphics&&this.timerGraphics.clear(),this.titleContainer&&this.titleContainer.removeAll(!0)}})}destroy(){this.container&&this.container.destroy()}}class F extends p.Scene{constructor(){super({key:"Game"})}init(e){this.viewers=o.SCORING.VIEWER_START,this.score=0,this.combo=0,this.streamTime=0,this.eventDeadline=0,this.isPaused=!1,this.hardCoreMode=!!(e&&e.hardCoreMode===!0),this.hardCoreMode?(this.highScore=parseInt(localStorage.getItem("streamDramaHardCoreHighScore")||"0"),console.log(`🔥 HARD CORE MODE ACTIVATED! Starting viewers: ${this.viewers}, Hard Core High score: ${this.highScore}`)):(this.highScore=parseInt(localStorage.getItem("streamDramaHighScore")||"0"),console.log(`Game initialized - Starting viewers: ${this.viewers}, High score: ${this.highScore}`)),this.responsiveLayout=new C(this.game),this.layout=this.responsiveLayout.getLayout()}create(){this.add.rectangle(0,0,this.layout.width,this.layout.height,657930).setOrigin(0),this.add.rectangle(0,this.layout.topBar.height,this.layout.width,this.layout.height-this.layout.topBar.height,o.COLORS.OVERLAY,.3).setOrigin(0),this.createLayoutSections(),this.createAnimations(),this.createEventBackground(),this.topBar=new R(this,this.responsiveLayout,this.hardCoreMode),this.bottomBar=new k(this,this.responsiveLayout),this.streamerBox=new L(this,this.responsiveLayout),this.timerDisplay=new I(this,this.responsiveLayout),this.soundManager=this.registry.get("soundManager"),this.soundManager||console.warn("Sound manager not found in registry"),this.chatManager=new A(this,this.responsiveLayout),this.eventManager=new b(this,this.hardCoreMode),this.startBackgroundMusic(),this.setupEventListeners(),this.setupPauseHandling(),this.startGameLoops();const e=p.Math.Between(o.EVENT_SPAWN_DELAY_MIN,o.EVENT_SPAWN_DELAY_MAX);this.time.delayedCall(e,()=>this.eventManager.spawnEvent())}createAnimations(){this.anims.exists("ps-roach-idle")||this.anims.create({key:"ps-roach-idle",frames:this.anims.generateFrameNumbers("ps-roach",{start:0,end:-1}),frameRate:10,repeat:-1});for(let e=1;e<=o.STREAM_BACKGROUNDS.COUNT;e++){const s=`stream-bg-${e.toString().padStart(2,"0")}`,i=`${s}-anim`;this.anims.exists(i)||this.anims.create({key:i,frames:this.anims.generateFrameNumbers(s,{start:0,end:o.STREAM_BACKGROUNDS.FRAME_CONFIG.totalFrames-1}),frameRate:o.STREAM_BACKGROUNDS.ANIMATION_CONFIG.frameRate,repeat:0})}this.currentBgNumber=p.Math.Between(1,o.STREAM_BACKGROUNDS.COUNT),this.currentBgKey=`stream-bg-${this.currentBgNumber.toString().padStart(2,"0")}`,this.currentBgAnimKey=`${this.currentBgKey}-anim`}createLayoutSections(){const e=this.add.graphics();e.lineStyle(this.responsiveLayout.scale(2),4473924,.3),e.setDepth(10),e.strokeRect(this.layout.eventSpace.x,this.layout.eventSpace.y,this.layout.eventSpace.width,this.layout.eventSpace.height),e.strokeRect(this.layout.chatSpace.x,this.layout.chatSpace.y,this.layout.chatSpace.width,this.layout.chatSpace.height)}createEventBackground(){this.eventBgContainer=this.add.container(this.layout.eventSpace.x,this.layout.eventSpace.y),this.eventBgContainer.setDepth(1);const e=this.make.graphics();e.fillRect(this.layout.eventSpace.x,this.layout.eventSpace.y,this.layout.eventSpace.width,this.layout.eventSpace.height);const t=new p.Display.Masks.GeometryMask(this,e);this.eventBgContainer.setMask(t),this.eventBg=this.add.sprite(this.layout.eventSpace.width/2,this.layout.eventSpace.height/2,this.currentBgKey),this.startBackgroundLoop();const s=this.layout.eventSpace.width/this.eventBg.width,i=this.layout.eventSpace.height/this.eventBg.height,n=Math.max(s,i);this.eventBg.setScale(n),this.eventBg.setAlpha(.4),this.eventBgContainer.add(this.eventBg)}startBackgroundLoop(){this.eventBg.play(this.currentBgAnimKey),this.eventBg.on("animationcomplete",()=>{this.switchToRandomBackground()})}switchToRandomBackground(){let e;do e=p.Math.Between(1,o.STREAM_BACKGROUNDS.COUNT);while(e===this.currentBgNumber&&o.STREAM_BACKGROUNDS.COUNT>1);this.currentBgNumber=e,this.currentBgKey=`stream-bg-${this.currentBgNumber.toString().padStart(2,"0")}`,this.currentBgAnimKey=`${this.currentBgKey}-anim`,this.eventBg.setTexture(this.currentBgKey),this.eventBg.play(this.currentBgAnimKey)}setupPauseHandling(){this.events.on("pause",()=>{this.isPaused=!0,this.showPauseOverlay()}),this.events.on("resume",()=>{this.isPaused=!1,this.hidePauseOverlay()})}showPauseOverlay(){this.pauseOverlay||(this.pauseOverlay=this.add.rectangle(this.layout.width/2,this.layout.height/2,this.layout.width,this.layout.height,0,.7).setDepth(9999),this.pauseText=this.add.text(this.layout.width/2,this.layout.height/2-20,"GAME PAUSED",{...o.TEXT_STYLES.TITLE,fontSize:"20px",color:"#FFFFFF"}).setOrigin(.5).setDepth(1e4),this.resumeText=this.add.text(this.layout.width/2,this.layout.height/2+15,"Return to tab to resume",{...o.TEXT_STYLES.UI,fontSize:"8px",color:"#CCCCCC"}).setOrigin(.5).setDepth(1e4),this.tweens.add({targets:this.pauseText,alpha:[1,.5],duration:1e3,repeat:-1,yoyo:!0}))}hidePauseOverlay(){this.pauseOverlay&&(this.pauseOverlay.destroy(),this.pauseOverlay=null),this.pauseText&&(this.pauseText.destroy(),this.pauseText=null),this.resumeText&&(this.resumeText.destroy(),this.resumeText=null)}setupEventListeners(){this.events.on("event:started",(e,t)=>{this.showEventTimer(e,t)}),this.events.on("event:ended",()=>{this.hideEventTimer()}),this.events.on("event:success",()=>{this.combo++,m.playSuccess(this,this.combo);const e=o.SCORING.VIEWER_GAIN_SUCCESS;this.combo===5?(this.chatManager.addSystemMessage("5 COMBO! Chat going wild!",o.COLORS.PRIMARY),m.play(this,"viewer_gain",{volume:.5})):this.combo===10?(this.chatManager.addSystemMessage("10 COMBO! LEGENDARY!",o.COLORS.PRIMARY),S.addScreenShake(this,10,300),m.playCelebration(this)):this.combo===20&&(this.chatManager.addSystemMessage("20 COMBO! GODLIKE STREAMER!",o.COLORS.PRIMARY),this.updateStats(50,0),m.play(this,"new_high_score",{volume:.8}));const t=["NICE!","POG!","CLEAN!","EZ!","W!","BASED!"];this.showFeedback(p.Utils.Array.GetRandom(t),o.COLORS.SUCCESS),this.updateStats(e,0),this.hideEventTimer(),this.eventManager.clearEvent(),this.streamerBox&&this.streamerBox.addReaction("success");const s=p.Math.Between(o.EVENT_SPAWN_DELAY_MIN,o.EVENT_SPAWN_DELAY_MAX);this.time.delayedCall(s,()=>this.eventManager.spawnEvent())}),this.events.on("event:fail",()=>{this.combo=0,m.playFail(this),m.play(this,"viewer_loss",{volume:.4}),this.updateStats(-20,0);const e=["SKILL ISSUE!","L!","RIPBOZO!","CAUGHT!","FAIL!","CRINGE!"];this.showFeedback(p.Utils.Array.GetRandom(e),o.COLORS.FAIL),this.hideEventTimer(),this.eventManager.clearEvent(),this.streamerBox&&this.streamerBox.addReaction("fail");const t=p.Math.Between(o.EVENT_SPAWN_DELAY_MIN,o.EVENT_SPAWN_DELAY_MAX);this.time.delayedCall(t,()=>this.eventManager.spawnEvent())}),this.events.on("ban:complete",(e=1)=>{m.play(this,"ban_hammer",{volume:.6}),this.updateStats(-(e*o.SCORING.VIEWER_LOSS_BAN),0),this.streamerBox&&this.streamerBox.addReaction("ban")}),this.events.on("covid:cleared",()=>{this.updateStats(-5,0),this.showFeedback("COVID DEFEATED!",o.COLORS.HEARTBOUND),this.streamerBox&&this.streamerBox.addReaction("covid")}),this.input.on("pointerdown",e=>{this.eventManager.currentEvent&&this.eventManager.checkInput("pointer",e)}),this.input.keyboard.on("keydown",e=>{if(this.eventManager.currentEvent&&m.playKeypress(this),e.code.startsWith("Arrow"))this.eventManager.checkInput("key",e.code.toUpperCase());else{const t=e.key.toUpperCase(),s=e.code.replace("Key","").toUpperCase();this.eventManager.checkInput("key",t)||this.eventManager.checkInput("key",s)}})}showEventTimer(e,t){this.eventDeadline=t,this.currentEventConfig=e;const s=(e==null?void 0:e.timeout)||3e3,i=Math.max(0,t-Date.now());this.timerDisplay&&this.timerDisplay.showTimer(e,i,s),this.updateEventTimer()}hideEventTimer(){this.eventDeadline=0,this.currentEventConfig=null,this.timerDisplay&&this.timerDisplay.hideTimer()}updateEventTimer(){var i;if(!this.eventDeadline||!this.currentEventConfig)return;const e=Date.now(),t=Math.max(0,this.eventDeadline-e),s=((i=this.currentEventConfig)==null?void 0:i.timeout)||3e3;this.timerDisplay&&this.timerDisplay.updateTimer(t,s),t<=0&&this.hideEventTimer()}startGameLoops(){this.time.addEvent({delay:o.CHAT.MESSAGE_RATE,loop:!0,callback:()=>{this.chatManager.addMessage(),Math.random()<.2&&this.time.delayedCall(100,()=>this.chatManager.addMessage()),Math.random()<.1&&this.time.delayedCall(200,()=>this.chatManager.addMessage())}}),this.time.addEvent({delay:1e3,loop:!0,callback:()=>{this.isPaused||(this.streamTime++,this.topBar.updateStreamTime(this.streamTime),this.score=this.streamTime,this.topBar.updateScore(this.score),this.streamTime%30===0&&console.log(`Stream time: ${this.streamTime}s, Score: ${this.score}, Viewers: ${this.viewers}`),this.score>this.highScore&&(this.highScore=this.score,this.saveHighScore(),this.topBar.updateHighScore(this.highScore),this.score%10===0&&console.log(`New high score: ${this.score}`)))}}),this.time.addEvent({delay:100,loop:!0,callback:()=>this.updateEventTimer()}),this.time.addEvent({delay:o.SCORING.VIEWER_FLUCTUATION_RATE,loop:!0,callback:()=>{if(Math.random()<.3&&!this.isPaused){const e=p.Math.Between(...o.SCORING.VIEWER_FLUCTUATION);this.updateStats(e,0)}}}),this.time.addEvent({delay:8e3,loop:!0,callback:()=>{if(this.isPaused)return;const e=[{msg:"Thor_Gaming has joined!",color:o.COLORS.FERRET},{msg:"RAID: 50 viewers from CodingStream!",color:o.COLORS.PRIMARY},{msg:"New follower: "+S.generateUsername(),color:o.COLORS.ACCENT},{msg:"GlitchyDev subscribed!",color:o.COLORS.SUB},{msg:"MagicNumbers donated $5!",color:o.COLORS.VIP}],t=p.Utils.Array.GetRandom(e);this.chatManager.addSystemMessage(t.msg,t.color),t.msg.includes("RAID")&&(this.updateStats(50,0),this.showFeedback("RAID!",o.COLORS.PRIMARY),S.createParticleBurst(this,o.WIDTH/2,o.HEIGHT/2))}})}updateStats(e,t){this.viewers=Math.max(0,this.viewers+e),this.topBar.updateViewerCount(this.viewers),this.viewers<50&&this.viewers>0?this.warningShown||(this.warningShown=!0,this.chatManager.addSystemMessage("Stream dying! Do something!",o.COLORS.FAIL),S.addScreenShake(this,5,200),m.play(this,"low_time",{volume:.6})):this.viewers<20&&this.viewers>0?this.criticalWarningShown||(this.criticalWarningShown=!0,this.chatManager.addSystemMessage("STREAM CRITICAL! ABOUT TO END!",o.COLORS.FAIL),S.addScreenShake(this,10,500),m.play(this,"critical_time",{volume:.8})):(this.warningShown=!1,this.criticalWarningShown=!1)}showFeedback(e,t){const s=this.add.text(o.WIDTH/2,o.HEIGHT/2,e,{fontSize:"16px",fontFamily:'"Press Start 2P"',color:t,stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(1e3);s.x+=p.Math.Between(-30,30),s.y+=p.Math.Between(-20,20),this.tweens.add({targets:s,y:s.y-40,alpha:{from:1,to:0},scale:{from:1,to:1.5},duration:o.ANIM_FEEDBACK,ease:"Power2",onComplete:()=>s.destroy()})}update(e){this.eventManager.checkDeadline(e),this.viewers<=0&&!this.isPaused&&this.handleGameOver("Lost all viewers")}saveHighScore(){const e=this.hardCoreMode?"streamDramaHardCoreHighScore":"streamDramaHighScore";localStorage.setItem(e,this.highScore.toString())}handleGameOver(e){this.score>this.highScore?m.play(this,"new_high_score",{volume:.9}):m.play(this,"timeout",{volume:.7});const t=this.hardCoreMode?"🔥 Hard Core":"Normal";console.log(`${t} Game Over - Final score: ${this.score}, Current high score: ${this.highScore}`),this.score>this.highScore?(this.highScore=this.score,this.saveHighScore(),this.topBar.updateHighScore(this.highScore),console.log(`New ${t.toLowerCase()} high score saved: ${this.score}`)):console.log(`Score ${this.score} did not beat ${t.toLowerCase()} high score ${this.highScore}`),M("GameOver",{score:this.score,streamTime:this.streamTime,reason:e,hardCoreMode:this.hardCoreMode}).catch(s=>{console.error("Failed to start GameOver scene:",s)})}startBackgroundMusic(){m.play(this,"game_music",{volume:.25}),this.time.addEvent({delay:8e3,loop:!0,callback:()=>{m.play(this,"game_music",{volume:.25})}})}shutdown(){console.log("🔄 Game scene shutting down - cleaning up managers"),this.hidePauseOverlay(),this.chatManager&&this.chatManager.clear(),this.eventManager&&(this.eventManager.cleanup(),this.eventManager.clearEvent()),this.bottomBar&&this.bottomBar.destroy(),this.timerDisplay&&this.timerDisplay.destroy(),this.streamerBox&&this.streamerBox.destroy()}}const B=Object.freeze(Object.defineProperty({__proto__:null,GameScene:F},Symbol.toStringTag,{value:"Module"}));export{w as K,B as g};

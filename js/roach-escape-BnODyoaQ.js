import{B as y}from"./base-event-BLT1_Wdv.js";import{C as m}from"./index-c0fuZDJO.js";class S extends y{constructor(t,e,n){super(t,e,n),this.partyMembers=[],this.player=null,this.monster=null,this.lifeGem=null,this.exitDoor=null,this.dungeonMap=[],this.tileSize=this.config.tileSize,this.mapWidth=this.config.mapWidth,this.mapHeight=this.config.mapHeight,this.playerSpeed=this.config.playerSpeed,this.monsterSpeed=this.config.monsterSpeed,this.partyDeathRate=this.config.partyDeathRate,this.playerMoving=!1,this.gameEnded=!1,this.bossPhase="attacking_party",this.bossMoving=!1}start(){this.setupEventSpace(),this.createDungeon(),this.createParty(),this.createMonster(),this.createItems(),this.setupControls(),this.startPartyDeaths(),this.startBossMovement()}setupEventSpace(){const t=this.scene.add.graphics();t.fillStyle(0,1),t.fillRect(this.eventArea.x,this.eventArea.y,this.eventArea.width,this.eventArea.height),t.lineStyle(3,parseInt(this.config.color.replace("#","0x")),1),t.strokeRect(this.eventArea.x,this.eventArea.y,this.eventArea.width,this.eventArea.height),this.trackElement(t);const e=this.scene.add.text(this.eventArea.x+this.eventArea.width/2,this.eventArea.y+5,"GOTTA ROACH OUT!",{...m.TEXT_STYLES.UI_SMALL,color:this.config.color}).setOrigin(.5);this.trackElement(e),this.instructionText=this.scene.add.text(this.eventArea.x+this.eventArea.width/2,this.eventArea.y+this.eventArea.height-5,"Escape from the boss room!",{...m.TEXT_STYLES.MICRO,color:"#FFFFFF"}).setOrigin(.5),this.trackElement(this.instructionText)}createDungeon(){const t=this.eventArea.width-20,e=this.eventArea.height-40,n=Math.floor(t/this.mapWidth),s=Math.floor(e/this.mapHeight);this.tileSize=Math.min(n,s,this.tileSize);const o=this.mapWidth*this.tileSize;this.mapHeight*this.tileSize,this.dungeonX=this.eventArea.x+(this.eventArea.width-o)/2,this.dungeonY=this.eventArea.y+25,this.dungeonGraphics=this.scene.add.graphics(),this.trackElement(this.dungeonGraphics),this.dungeonMap=this.generateDungeon();for(let a=0;a<this.mapHeight;a++)for(let r=0;r<this.mapWidth;r++){const l=this.dungeonMap[a][r],c=this.dungeonX+r*this.tileSize,d=this.dungeonY+a*this.tileSize;switch(l){case 0:this.dungeonGraphics.fillStyle(4473924,1),this.dungeonGraphics.fillRect(c,d,this.tileSize,this.tileSize);break;case 1:this.dungeonGraphics.fillStyle(2236962,1),this.dungeonGraphics.fillRect(c,d,this.tileSize,this.tileSize),this.dungeonGraphics.lineStyle(1,3355443,.5),this.dungeonGraphics.strokeRect(c,d,this.tileSize,this.tileSize);break;case 2:this.dungeonGraphics.fillStyle(3342336,1),this.dungeonGraphics.fillRect(c,d,this.tileSize,this.tileSize),this.dungeonGraphics.lineStyle(1,6684672,.5),this.dungeonGraphics.strokeRect(c,d,this.tileSize,this.tileSize);break;case 3:this.dungeonGraphics.fillStyle(65280,.3),this.dungeonGraphics.fillRect(c,d,this.tileSize,this.tileSize),this.dungeonGraphics.lineStyle(2,65280,1),this.dungeonGraphics.strokeRect(c,d,this.tileSize,this.tileSize);break}}const i=this.dungeonX+1*this.tileSize,h=this.dungeonY+1*this.tileSize;this.exitDoor=this.scene.add.text(i+this.tileSize/2,h+this.tileSize/2,"EXIT",{...m.TEXT_STYLES.MICRO,color:"#00FF00"}).setOrigin(.5),this.trackElement(this.exitDoor)}generateDungeon(){const t=Array(this.mapHeight).fill().map(()=>Array(this.mapWidth).fill(0));for(let h=0;h<this.mapHeight;h++)for(let a=0;a<this.mapWidth;a++)(a===0||a===this.mapWidth-1||h===0||h===this.mapHeight-1)&&(t[h][a]=0);const e=Math.floor(this.mapWidth/4),n=1,s=Math.floor(this.mapWidth*.75),o=Math.floor(this.mapHeight/2);t[n][e]=3,t[n][e+1]=3;for(let h=-1;h<=1;h++)for(let a=-1;a<=1;a++){const r=s+a,l=o+h;r>=1&&r<this.mapWidth-1&&l>=1&&l<this.mapHeight-1&&(t[l][r]=2)}const i=this.findPath({x:s,y:o},{x:e,y:n},t);for(const h of i)t[h.y][h.x]===0&&(t[h.y][h.x]=1);return this.addRandomRooms(t,3,5),this.addRandomCorridors(t,8,12),this.ensureConnectivity(t,s,o),t}findPath(t,e,n){const s=[{...t,g:0,h:this.heuristic(t,e),f:0,parent:null}],o=[];for(;s.length>0;){let i=s[0],h=0;for(let r=1;r<s.length;r++)s[r].f<i.f&&(i=s[r],h=r);if(s.splice(h,1),o.push(i),i.x===e.x&&i.y===e.y){const r=[];let l=i;for(;l;)r.unshift({x:l.x,y:l.y}),l=l.parent;return r}const a=[{x:i.x+1,y:i.y},{x:i.x-1,y:i.y},{x:i.x,y:i.y+1},{x:i.x,y:i.y-1}];for(const r of a){if(r.x<1||r.x>=this.mapWidth-1||r.y<1||r.y>=this.mapHeight-1||o.some(g=>g.x===r.x&&g.y===r.y))continue;const l=i.g+1,c=this.heuristic(r,e),d=l+c,p=s.find(g=>g.x===r.x&&g.y===r.y);if(!p||l<p.g){const g={x:r.x,y:r.y,g:l,h:c,f:d,parent:i};p?Object.assign(p,g):s.push(g)}}}return[t,e]}heuristic(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}addRandomRooms(t,e,n){const s=Math.floor(Math.random()*(n-e+1))+e;for(let o=0;o<s;o++){const i=Math.floor(Math.random()*3)+2,h=Math.floor(Math.random()*2)+2,a=Math.floor(Math.random()*(this.mapWidth-i-2))+1,r=Math.floor(Math.random()*(this.mapHeight-h-2))+1;let l=!1;for(let c=r;c<r+h;c++){for(let d=a;d<a+i;d++)if(t[c][d]===2||t[c][d]===3){l=!0;break}if(l)break}if(!l)for(let c=r;c<r+h;c++)for(let d=a;d<a+i;d++)t[c][d]=1}}addRandomCorridors(t,e,n){const s=Math.floor(Math.random()*(n-e+1))+e;for(let o=0;o<s;o++){const i=Math.floor(Math.random()*(this.mapWidth-2))+1,h=Math.floor(Math.random()*(this.mapHeight-2))+1;t[h][i]!==2&&t[h][i]!==3&&(t[h][i]=1)}}ensureConnectivity(t,e,n){const s=Array(this.mapHeight).fill().map(()=>Array(this.mapWidth).fill(!1)),o=[{x:e,y:n}];for(;o.length>0;){const{x:i,y:h}=o.pop();i<0||i>=this.mapWidth||h<0||h>=this.mapHeight||s[h][i]||t[h][i]===0||(s[h][i]=!0,o.push({x:i+1,y:h},{x:i-1,y:h},{x:i,y:h+1},{x:i,y:h-1}))}for(let i=1;i<this.mapHeight-1;i++)for(let h=1;h<this.mapWidth-1;h++)(t[i][h]===1||t[i][h]===3)&&!s[i][h]&&this.createCorridor(t,{x:h,y:i},{x:e,y:n})}createCorridor(t,e,n){let s=e.x,o=e.y;for(;s!==n.x;)t[o][s]===0&&(t[o][s]=1),s+=s<n.x?1:-1;for(;o!==n.y;)t[o][s]===0&&(t[o][s]=1),o+=o<n.y?1:-1}createParty(){const t=Math.floor(this.mapWidth*.75),e=Math.floor(this.mapHeight/2),n=t-2,s=e;this.player=this.createCharacter(n,s,"ðŸª³","#FFD700","You"),this.player.gridX=n,this.player.gridY=s;const o=["#FF6B6B","#4ECDC4","#FF69B4","#9370DB"],i=["Tank","Healer","DPS","Support"],h=[{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1}];for(let a=0;a<4;a++){const r=h[a],l=n+r.x,c=s+r.y;if(l!==t||c!==e){const d=this.createCharacter(l,c,"ðŸ¤º",o[a],i[a]);d.gridX=l,d.gridY=c,this.partyMembers.push(d)}}}createCharacter(t,e,n,s,o){const i=this.dungeonX+t*this.tileSize+this.tileSize/2,h=this.dungeonY+e*this.tileSize+this.tileSize/2,a=this.scene.add.container(i,h),r=this.scene.add.text(0,0,n,{fontSize:"14px"}).setOrigin(.5);a.add(r);const l=this.scene.add.text(0,-12,o,{fontSize:"6px",color:s,fontFamily:"Arial"}).setOrigin(.5);return a.add(l),a.emoji=n,a.charName=o,this.trackElement(a),a}createMonster(){const t=Math.floor(this.mapWidth*.75),e=Math.floor(this.mapHeight/2);this.monster=this.createCharacter(t,e,"ðŸ‘¹","#FF0000","BOSS"),this.monster.gridX=t,this.monster.gridY=e,this.monster.setScale(1.5)}createItems(){this.createItemBar(),this.lifeGem=this.scene.add.text(this.itemSlot.x+10,this.itemSlot.y+7.5,"ðŸ’Ž",{fontSize:"10px"}).setOrigin(.5).setInteractive({useHandCursor:!0}),this.trackElement(this.lifeGem),this.lifeGem.on("pointerover",()=>{this.showTooltip("Mana gem")}),this.lifeGem.on("pointerout",()=>{this.hideTooltip()}),this.lifeGem.on("pointerdown",()=>{this.useLifeGem()}),this.scene.tweens.add({targets:this.lifeGem,y:[this.lifeGem.y-1,this.lifeGem.y+1],duration:1e3,repeat:-1,yoyo:!0}),this.scene.tweens.add({targets:this.lifeGem,scale:[1,1.1,1],duration:2e3,repeat:-1}),this.itemText.setText("Items"),this.itemText.setColor("#FF6666")}createItemBar(){const t=this.scene.add.rectangle(this.eventArea.x+10,this.eventArea.y+this.eventArea.height-30,60,20,3355443).setOrigin(0).setStrokeStyle(1,16777215);this.trackElement(t),this.itemSlot=this.scene.add.rectangle(this.eventArea.x+15,this.eventArea.y+this.eventArea.height-25,20,15,0).setOrigin(0).setStrokeStyle(1,6710886),this.trackElement(this.itemSlot),this.itemText=this.scene.add.text(this.eventArea.x+40,this.eventArea.y+this.eventArea.height-20,"Items",{...m.TEXT_STYLES.MICRO,color:"#666666"}).setOrigin(0,.5),this.trackElement(this.itemText)}setupControls(){const t=this.scene.input.keyboard.createCursorKeys();t.up.on("down",()=>this.movePlayer(0,-1)),t.down.on("down",()=>this.movePlayer(0,1)),t.left.on("down",()=>this.movePlayer(-1,0)),t.right.on("down",()=>this.movePlayer(1,0))}movePlayer(t,e){if(this.playerMoving||this.gameEnded)return;const n=this.player.gridX+t,s=this.player.gridY+e;if(n<0||n>=this.mapWidth||s<0||s>=this.mapHeight||this.dungeonMap[s][n]===0)return;this.playerMoving=!0,this.player.gridX=n,this.player.gridY=s;const i=this.dungeonX+n*this.tileSize+this.tileSize/2,h=this.dungeonY+s*this.tileSize+this.tileSize/2;this.scene.tweens.add({targets:this.player,x:i,y:h,duration:200,onComplete:()=>{this.playerMoving=!1,this.checkPlayerPosition()}})}checkPlayerPosition(){if(this.dungeonMap[this.player.gridY][this.player.gridX]===3){this.escapeSuccess();return}if(this.bossPhase==="chasing_player"&&this.player.gridX===this.monster.gridX&&this.player.gridY===this.monster.gridY){this.bossCaughtPlayer();return}}useLifeGem(){this.gameEnded=!0,this.instructionText.setText("True roaches don't use items. FAIL!"),this.instructionText.setColor("#FF0000"),this.scene.time.delayedCall(1e3,()=>{this.fail()})}showTooltip(t){this.tooltip&&this.tooltip.destroy(),this.tooltip=this.scene.add.text(this.lifeGem.x,this.lifeGem.y-15,t,{fontSize:"8px",color:"#FFFFFF",backgroundColor:"#000000",padding:{x:4,y:2}}).setOrigin(.5,1),this.trackElement(this.tooltip)}hideTooltip(){this.tooltip&&(this.tooltip.destroy(),this.tooltip=null)}bossCaughtPlayer(){this.gameEnded=!0,this.instructionText.setText("The boss caught you! FAILURE!"),this.instructionText.setColor("#FF0000"),this.scene.tweens.add({targets:this.player,scale:0,angle:360,duration:500}),this.scene.time.delayedCall(1e3,()=>{this.fail()})}moveMonster(){if(this.gameEnded||this.bossMoving||this.bossPhase!=="chasing_player")return;this.bossMoving=!0;const t=Math.sign(this.player.gridX-this.monster.gridX),e=Math.sign(this.player.gridY-this.monster.gridY);let n=this.monster.gridX,s=this.monster.gridY;if(Math.random()>.5&&t!==0?n+=t:e!==0?s+=e:t!==0&&(n+=t),this.dungeonMap[s]&&this.dungeonMap[s][n]!==0){this.monster.gridX=n,this.monster.gridY=s;const o=this.dungeonX+n*this.tileSize+this.tileSize/2,i=this.dungeonY+s*this.tileSize+this.tileSize/2;this.scene.tweens.add({targets:this.monster,x:o,y:i,duration:300,onComplete:()=>{this.bossMoving=!1}})}else this.bossMoving=!1}startPartyDeaths(){this.deathTimer=this.scene.time.addEvent({delay:this.partyDeathRate,repeat:3,callback:()=>this.killPartyMember()}),this.trackTimer(this.deathTimer)}killPartyMember(){const t=this.partyMembers.filter(o=>o.list[0].text!=="ðŸ’€");if(t.length===0)return;const e=Phaser.Utils.Array.GetRandom(t),n=this.dungeonX+e.gridX*this.tileSize+this.tileSize/2,s=this.dungeonY+e.gridY*this.tileSize+this.tileSize/2;this.scene.tweens.add({targets:this.monster,x:n,y:s,duration:200,onComplete:()=>{const o=this.dungeonX+this.monster.gridX*this.tileSize+this.tileSize/2,i=this.dungeonY+this.monster.gridY*this.tileSize+this.tileSize/2;this.scene.tweens.add({targets:this.monster,x:o,y:i,duration:200})}}),this.scene.tweens.add({targets:e,scale:0,angle:360,duration:500,delay:200,onComplete:()=>{e&&e.list&&e.list[0]&&e.list[0].setText&&(e.list[0].setText("ðŸ’€"),e.setScale(1),e.angle=0)}}),t.length===1?(this.instructionText.setText("Party is dead! Boss is coming for YOU!"),this.instructionText.setColor("#FF0000"),this.scene.time.delayedCall(1e3,()=>{this.bossPhase="chasing_player",this.instructionText.setText("RUN TO THE EXIT! Boss is chasing you!")})):(this.instructionText.setText(`${t.length-1} party members left...`),this.instructionText.setColor("#FFAA00"))}startBossMovement(){this.bossMovementTimer=this.scene.time.addEvent({delay:400,repeat:-1,callback:()=>{this.bossPhase==="chasing_player"&&!this.gameEnded&&(this.moveMonster(),this.player.gridX===this.monster.gridX&&this.player.gridY===this.monster.gridY&&this.bossCaughtPlayer())}}),this.trackTimer(this.bossMovementTimer)}escapeSuccess(){this.gameEnded=!0,this.partyMembers.filter(e=>e.list[0].text!=="ðŸ’€").length===0&&this.scene.chatManager.addSystemMessage("TRUE ROACH! Left party to die!",m.COLORS.ROACH),this.success()}}export{S as RoachEscapeEvent};
